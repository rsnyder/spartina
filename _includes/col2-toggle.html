{%- if page.juncture.mode_toggle == nil -%}
    {%- if site.juncture.mode_toggle == nil -%}
        {%- assign toggle_enabled = true -%}
    {% else %}
        {%- assign toggle_enabled = site.juncture.mode_toggle -%}
    {%- endif -%}
{%- else -%}
    {%- assign toggle_enabled = page.juncture.mode_toggle -%}
{%- endif -%}

{%- if page.juncture.mode == nil -%}    
    {%- if site.juncture.mode == nil -%}
        {%- assign default_mode = 'flat' -%}
    {% else %}
        {%- assign default_mode = site.juncture.mode -%}
    {%- endif -%}
{%- else -%}
    {%- assign default_mode = page.juncture.mode -%}
{%- endif -%}

{%- if default_mode == 'flat' -%}
    {%- assign default_class = 'col1' -%}
{%- else -%}
    {%- assign default_class = 'col2' -%}
{%- endif -%}


{%- if toggle_enabled -%}

<a href="#" class="js-col2-toggle" aria-label="Toggle layout" title="Toggle layout"
    style="margin-right:1em; cursor:pointer;">
    <i class="fa-solid fa-table-columns" aria-hidden="true"></i>
</a>

{%- endif -%}


<script type="module">
    const toggleEnabled = {{ toggle_enabled | jsonify }};
    const defaultClass = {{ default_class  | jsonify }};

    const STORAGE_KEY = 'postViewMode';

    async function loadMain() {
        const mod = await import('{{ "/assets/js/juncture.js" | relative_url }}');
        return { isMobile: !!mod.isMobile, init2col: mod.init2col };
    }

    function setIcon(icon, isCol2) {
        if (!icon) return;
        icon.className = isCol2 ? 'fa-regular fa-square' : 'fa-solid fa-table-columns';
    }

    document.addEventListener('DOMContentLoaded', async () => {

        const mainWrapper = document.getElementById('main-wrapper');
        const btn = toggleEnabled && document.querySelector('.js-col2-toggle');
        const icon = toggleEnabled && btn.querySelector('i');

        if (!mainWrapper) return;

        const { isMobile, init2col } = await loadMain();

        async function setViewMode(mode) {
            const effectiveMode = isMobile ? 'col1' : mode;
            const toCol2 = effectiveMode === 'col2';

            mainWrapper.classList.toggle('col2', toCol2);
            mainWrapper.classList.toggle('col1', !toCol2);

            setIcon(icon, toCol2);

            if (toCol2 && typeof init2col === 'function') {
                try { init2col(); }
                catch (err) { console.error('Failed to init col2 mode:', err); }
            }

            localStorage.setItem(STORAGE_KEY, effectiveMode);
        }

        if (isMobile) {
            btn?.remove();
            await setViewMode('col1');
            return;
        }

        toggleEnabled && btn.addEventListener('click', async (e) => {
            e.preventDefault();
            const isCurrentlyCol2 = mainWrapper.classList.contains('col2');
            await setViewMode(isCurrentlyCol2 ? 'col1' : 'col2');
        });

        const saved = localStorage.getItem(STORAGE_KEY);
        await setViewMode(
            toggleEnabled ? saved === 'col2' ? 'col2' : defaultClass : defaultClass);
    });
</script>